name: "SemVer Check & Preview"

on:
  pull_request:
    types: [opened, edited, synchronized]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  validate-and-preview:
    name: Validate Commits & Predict Version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ObrigatÃ³rio para analisar o histÃ³rico

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Instala dependÃªncias na pasta atual para o script poder usar
      - name: Install Analysis Tools
        run: |
          npm install --no-save @commitlint/config-conventional @commitlint/cli conventional-recommended-bump semver

      - name: Create Commitlint Config
        run: |
          echo "module.exports = {extends: ['@commitlint/config-conventional']}" > commitlint.config.js

      # Passo 1: ValidaÃ§Ã£o
      - name: Validate Commits (Commitlint)
        run: |
          npx commitlint --from ${{ github.event.pull_request.base.sha }} --to ${{ github.event.pull_request.head.sha }} --verbose

      # Passo 2: PrevisÃ£o (Corrigido o erro do 'exec')
      - name: Calculate Next Version
        id: prediction
        uses: actions/github-script@v7
        with:
          script: |
            // ImportaÃ§Ãµes usando caminho absoluto para garantir que ache os mÃ³dulos instalados
            const startPath = process.cwd();
            const semver = require(startPath + '/node_modules/semver');
            const recommendedBump = require(startPath + '/node_modules/conventional-recommended-bump');
            const { promisify } = require('util');
            
            // CORREÃ‡ÃƒO AQUI: Mudamos o nome de 'exec' para 'execPromise' para evitar colisÃ£o
            const execPromise = promisify(require('child_process').exec);
            const bumpPromise = promisify(recommendedBump);

            // 1. Descobre a versÃ£o atual (tag)
            let currentVersion = '0.0.0';
            try {
              const { stdout } = await execPromise('git describe --tags --abbrev=0');
              currentVersion = stdout.trim();
              if (currentVersion.startsWith('v')) currentVersion = currentVersion.slice(1);
            } catch (error) {
              console.log('Nenhuma tag encontrada, assumindo v0.0.0 como base.');
            }

            // 2. Analisa os commits
            let releaseType = 'patch';
            try {
              const recommendation = await bumpPromise({ preset: 'angular' });
              releaseType = recommendation.releaseType;
            } catch (err) {
              console.log('Erro ao calcular bump, fallback para patch.');
            }

            // 3. Calcula a prÃ³xima versÃ£o
            const nextVersion = semver.inc(currentVersion, releaseType);
            
            console.log(`VersÃ£o Atual: ${currentVersion}`);
            console.log(`Tipo de Bump: ${releaseType}`);
            console.log(`PrÃ³xima VersÃ£o: ${nextVersion}`);

            core.setOutput('current_version', currentVersion);
            core.setOutput('next_version', nextVersion);
            core.setOutput('bump_type', releaseType);

      # Passo 3: ComentÃ¡rio
      - name: Comment Prediction
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## ğŸ¤– SemVer Preview
            
            Validamos seus commits e calculamos o impacto desta mudanÃ§a:
            
            | Atual | Impacto | **Prevista** |
            | :---: | :---: | :---: |
            | `v${{ steps.prediction.outputs.current_version }}` | **${{ steps.prediction.outputs.bump_type }}** | `v${{ steps.prediction.outputs.next_version }}` |
            
            > **Nota:** A versÃ£o final serÃ¡ gerada apenas apÃ³s o merge.
          edit-mode: replace
