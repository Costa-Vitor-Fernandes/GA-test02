name: "SemVer Check & Preview"

on:
  pull_request:
    types: [opened, edited, synchronize]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  validate-and-preview:
    name: Validate Commits & Predict Version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Obrigat칩rio para analisar o hist칩rico de commits

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Instalamos as depend칡ncias necess치rias no ambiente do runner
      - name: Install Analysis Tools
        run: |
          npm install --no-save @commitlint/config-conventional @commitlint/cli conventional-recommended-bump semver

      # CORRE칂츾O: Usamos o pipe (|) para evitar erro de sintaxe com aspas/chaves
      - name: Create Commitlint Config
        run: |
          echo "module.exports = {extends: ['@commitlint/config-conventional']}" > commitlint.config.js

      # Passo 1: Valida칞칚o (Linta os commits do PR)
      - name: Validate Commits (Commitlint)
        run: |
          npx commitlint --from ${{ github.event.pull_request.base.sha }} --to ${{ github.event.pull_request.head.sha }} --verbose

      # Passo 2: Previs칚o da Vers칚o (Script Inline)
      # Aqui usamos actions/github-script com o c칩digo embutido para evitar o erro "Cannot find module"
      - name: Calculate Next Version
        id: prediction
        uses: actions/github-script@v7
        with:
          script: |
            // Importa m칩dulos instalados no passo anterior
            // Usamos process.cwd() para garantir que o require ache a pasta node_modules local
            const startPath = process.cwd();
            const semver = require(startPath + '/node_modules/semver');
            const recommendedBump = require(startPath + '/node_modules/conventional-recommended-bump');
            const { promisify } = require('util');
            const exec = promisify(require('child_process').exec);
            const bump = promisify(recommendedBump);

            // 1. Descobre a vers칚o atual (tag)
            let currentVersion = '0.0.0';
            try {
              // Pega a 칰ltima tag dispon칤vel
              const { stdout } = await exec('git describe --tags --abbrev=0');
              currentVersion = stdout.trim();
              if (currentVersion.startsWith('v')) currentVersion = currentVersion.slice(1);
            } catch (error) {
              console.log('Nenhuma tag encontrada, assumindo v0.0.0 como base.');
            }

            // 2. Analisa os commits para sugerir o bump (Major, Minor ou Patch)
            let releaseType = 'patch';
            try {
              const recommendation = await bump({ preset: 'angular' });
              releaseType = recommendation.releaseType;
            } catch (err) {
              console.log('Erro ao calcular bump, assumindo patch como fallback.');
            }

            // 3. Calcula a pr칩xima vers칚o
            const nextVersion = semver.inc(currentVersion, releaseType);
            
            console.log(`Vers칚o Atual: ${currentVersion}`);
            console.log(`Tipo de Bump: ${releaseType}`);
            console.log(`Pr칩xima Vers칚o: ${nextVersion}`);

            // Exporta output para ser usado no passo de coment치rio
            core.setOutput('current_version', currentVersion);
            core.setOutput('next_version', nextVersion);
            core.setOutput('bump_type', releaseType);

      # Passo 3: Coment치rio no PR
      - name: Comment Prediction
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## 游뱄 SemVer Preview
            
            Validamos seus commits e calculamos o impacto desta mudan칞a:
            
            | Atual | Impacto | **Prevista** |
            | :---: | :---: | :---: |
            | `v${{ steps.prediction.outputs.current_version }}` | **${{ steps.prediction.outputs.bump_type }}** | `v${{ steps.prediction.outputs.next_version }}` |
            
            > **Nota:** Se o impacto estiver errado, verifique se usou `fix:`, `feat:` ou `BREAKING CHANGE` corretamente nos commits.
          edit-mode: replace
