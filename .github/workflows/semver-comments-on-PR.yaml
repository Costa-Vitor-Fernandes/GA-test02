name: "SemVer Check & Preview"

on:
  pull_request:
    types: [opened, edited, synchronized]

permissions:
  contents: read
  pull-requests: write
  # Necess√°rio para a action postar status de sucesso/falha no commit
  statuses: write 

jobs:
  validate-and-preview:
    name: Validate & Predict
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --- SUBSTITUI√á√ÉO DO COMMITLINT ---
      # Esta action valida se o T√≠tulo do PR ou os Commits seguem o padr√£o.
      # Documenta√ß√£o: https://github.com/amannn/action-semantic-pull-request
      - name: Validate PR Title/Commits
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # Por padr√£o, valida apenas o T√çTULO do PR (ideal para Squash & Merge).
          # Se voc√™ quiser validar cada commit individualmente, descomente a linha abaixo:
          # validateSingleCommit: false
          # validateSingleCommitMatchesPrTitle: false
          
          # Tipos permitidos (padr√£o Angular j√° vem incluso, mas voc√™ pode for√ßar)
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert

      # --- C√ÅLCULO DE VERS√ÉO (Mantido via Node puro) ---
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Analysis Tools
        run: npm install --no-save conventional-recommended-bump semver

      - name: Calculate Next Version
        id: prediction
        run: |
          cat << 'EOF' > predict-version.js
          const semver = require('semver');
          const recommendedBump = require('conventional-recommended-bump');
          const { promisify } = require('util');
          const fs = require('fs');
          const { exec } = require('child_process');
          const execPromise = promisify(exec);
          const bumpPromise = promisify(recommendedBump);

          async function run() {
            let currentVersion = '0.0.0';
            try {
              const { stdout } = await execPromise('git describe --tags --abbrev=0');
              currentVersion = stdout.trim().replace(/^v/, '');
            } catch (error) {
              console.log('Nenhuma tag encontrada, base v0.0.0');
            }

            let releaseType = 'patch'; // Fallback seguro
            try {
              // Analisa os commits para determinar o bump
              const recommendation = await bumpPromise({ preset: 'angular' });
              releaseType = recommendation.releaseType;
            } catch (err) {
              console.log('N√£o foi poss√≠vel determinar o bump automaticamente.');
            }

            const nextVersion = semver.inc(currentVersion, releaseType);
            
            console.log(`Atual: ${currentVersion} | Bump: ${releaseType} | Pr√≥xima: ${nextVersion}`);

            fs.appendFileSync(process.env.GITHUB_OUTPUT, `current_version=${currentVersion}\n`);
            fs.appendFileSync(process.env.GITHUB_OUTPUT, `next_version=${nextVersion}\n`);
            fs.appendFileSync(process.env.GITHUB_OUTPUT, `bump_type=${releaseType}\n`);
          }

          run().catch(err => { console.error(err); process.exit(1); });
          EOF

          node predict-version.js

      - name: Comment Prediction
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## üöÄ SemVer Preview
            
            Validamos o padr√£o do PR e calculamos a pr√≥xima vers√£o:
            
            | Vers√£o Atual | Impacto Detectado | **Vers√£o Prevista** |
            | :---: | :---: | :---: |
            | `v${{ steps.prediction.outputs.current_version }}` | **${{ steps.prediction.outputs.bump_type }}** | `v${{ steps.prediction.outputs.next_version }}` |
            
            > **Aten√ß√£o:** Se o impacto estiver incorreto, edite o t√≠tulo do PR para come√ßar com `feat:`, `fix:` ou inclua `BREAKING CHANGE`.
          edit-mode: replace
